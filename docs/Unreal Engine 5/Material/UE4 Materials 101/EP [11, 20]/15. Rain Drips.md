---
layout: default
title: "15. Rain Drips"
parent: "EP [11 , 20]"
nav_order: 5
---

# EP 15 : Rain Drips
빗물이 벽면을 따라 흘러내리는 효과 구현하기

## Packed Texture
1. **Red & Green 채널**
   - 빗물이 흐르는 방향의 표면 굴곡
   - 노멀(Normal) 맵 X, Y 성분
2. **Blue 채널**
    - 물줄기가 실제로 존재하는 영역을 나타내는 마스크
    - 흰색 부분에만 물줄기가 흐르게 됨
3. **Alpha 채널**
    - 시간차 마스크(Temporal Offset Mask). 라인 별로 서로 다른 회색값을 가짐
    - 각 물줄기 라인이 서로 다른 시간에 애니메이션을 시작하도록 함

---

# 그래프 예제
전체적인 흐름

1. **데이터 텍스처 제작**
   - 흘러내리는 물줄기 효과에 필요한 정보(노멀, 마스크 등)를 채널 패킹 기법으로 준비
2. **월드 공간 프로젝션**
   - UV 좌표 대신 월드 좌표를 사용하여, 모델의 형태와 무관하게 텍스처를 왜곡 없이 투영
3. **drip mask 애니메이션**
   - 세로형 그라디언트 텍스쳐를 world position UV (x,z) 로 사용
   - offset mask (알파 채널) + time 과 결합하여 물이 위에서 아래로 흐르는 애니메이션 구현
4. **표면 특성에 따른 속도 제어**
    - 빠른 표면(금속) / 느린 표면(돌·천) 속도 다르게 설정
    - `Lerp(0.2, 0.75, offset mask)` 로 스크롤 차이 생성
5. **노멀 계산**
    - R,G 채널로 노멀 생성
6. **상단 영역 제거 마스크 (Up mask)**
    - VertexNormalWS → Z 채널 → Abs → Lerp(3.5, -1.5) → Saturate
    - 최종 Drip Mask에 곱해 위·아래면에서 물이 안 보이게 처리
7. **Roughness 조절**
    - Drip Mask → Power(0.5) - 1-x
    - 흘러내리는 부분만 매끈하고 반사되는 재질
8. **최종 효과 합성**
    - 생성된 모든 요소(노멀, 마스크, Roughness 등)를 결합하여 사실적인 물줄기 효과를 완성

---

## world space projection
UV 대신 월드 좌표를 사용해 모든 오브젝트에 동일하게 수직 방향 (중력 방향)으로 텍스처를 투영

## 텍스쳐 투영 축 결정
1. **U축**
    - X 또는 Y
    - 정면일때 X 사용
    - 측면일때 Y 사용
2. **V축**
    - Z (수직 방향, 빗물이 흐르는 축)


### Front UV
정면용 UV

```
U = WorldPos.X * scaleX
V = WorldPos.Z * scaleZ
```

### Side UV
측면용 UV

```
U = WorldPos.Y * scaleY
V = WorldPos.Z * scaleZ
```

### 버텍스 노멀을 이용해 UV 판단
1. VertexNormal의 부호와 절댓값을 이용해 어느 면이 정면/측면에 가까운지 계산
2. 그 값을 Lerp의 알파로 사용

```
U = Lerp( U_front, U_side, mask )
V = Z * scaleZ
```

---

### Scale and Tiling
world position 의 월드 좌표값은 `cm`

- UE 기본 단위: 1 m = 100 cm

### UV 스케일 적용
S : cm당 UV 증가량

```
UV = WorldPos × S
```

- 예 : S가 0.01

```
1 cm당 UV 0.01 증가

100 cm당 UV 1 증가
```

**예**
- 1 m 당 1타일 : S = 1/100 = 0.01
- 1 m 당 3타일 : S = 3/100 = 0.03
- 1 m 당 0.3타일 : S = 0.3/100 = 0.003

| S     | 타일수/미터 | 해석 |
| --- | --- | --- |
| 0.01  | 1      | UV 1 |
| 0.03  | 3      | UV 3 타일링 |
| 0.003 | 0.3    | UV 반복 안 됨, 타일 큼 |

> S가 커질수록 자주 반복 (타일링), S가 작을수록 타일이 커지고 반복이 적어짐

---

## Drip Mask (GrayScale)
1. Absolute World Position
    - (X, Y, Z) = (R, G, B)
2. Component Mask (R,B)
    - (X,Z) 축만 사용
    - X를 U로, Z를 V로 사용

> R,B = (X,Z)만 쓰면 투영이 XZ 평면 고정 (월드 포지션은 빔 프로젝터)

---

## Up Mask
1. **Vertex Normal의 Z 성분 추출**
   - 정육면체 기준
   - 위(+Z): +1
   - 아래(–Z): –1
   - 옆면: 0
2.  **Abs 적용**
    - 상단과 하단이 모두 1, 측면만 0
    - 목적: 위와 아래를 같이 처리할 수 있는 마스크로 만들기
3. **Lerp(3.5, –1.5, x)**
   - x = 0 (측면): 3.5
   - x = 1 (상단/하단): –1.5
   - 값이 **측면은 높고, 위아래는 낮은 분포**
4. **Saturate(0~1 클램프)**
   - 중간값을 0~1 사이로 매핑

### 결과
```
측면 → 흰색(1)

위·아래 → 검정(0)

경계 부근 → 회색 (0~1)
```

빗방울이 측면에만 나타나고 상단/하단은 제거되는 마스크 완성

---
