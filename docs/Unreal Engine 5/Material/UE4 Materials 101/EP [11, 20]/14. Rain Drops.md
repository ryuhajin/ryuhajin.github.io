---
layout: default
title: "14. Rain Drops"
parent: "EP [11 , 20]"
nav_order: 4
---

# EP 14 : Rain Drops
빗방울이 떨어지는 듯한 머테리얼 만들기

## Packed Texture
하나의 4채널(RGBA) 텍스처에 필요한 모든 정보를 압축해서 담기

1. **Red & Green 채널**
   - 빗방울 노멀(Normal) 맵의 X, Y 성분
2. **Blue 채널**
    - 시간차 마스크(Temporal Offset Mask)
    - 각 빗방울의 애니메이션이 서로 다른 시간에 시작되도록 하기 위한 회색조(grayscale) 값
3. **Alpha 채널**
    - 정적/동적 구분 마스크(Static/Animated Mask)
    - 검정색 (0) : 정적인(static) 빗방울
    - 흰색 (1) : 애니메이션이 적용될(animated) 빗방울

---

# 그래프 예제

## 노멀 맵(Normal Map) 생성 및 범위 변환
TGA 텍스쳐 파일은 채널의 정보를 0에서 1 사이의 값으로 저장한다

- 노멀 벡터는 -1에서 1 사이의 범위를 가지므로 범위를 변환해야 한다
- [-1, 1]

```
normal.x, normal.y * 2 - 1
```

- 깊이감 강하게 표현하기
- **[-2, 2] 범위**

```
normal.x, normal.y * 4 - 2
```

### 왜 깊이감이 더 생기는가?
1. **[-1, 1]의 경우**
   - X' = 1 * 2 - 1 = 1
   - Y' = 0.5 * 2 - 1 = 0
   - 초기 벡터: (1, 0, 1) → **정규화 후: (0.707, 0, 0.707) (약 45도 기울기)**
2. [-2, 2]의 경우
   - X' = 1 * 4 - 2 = 2
   - Y' = 0.5 * 4 - 2 = 0
   - 초기 벡터: (2, 0, 1) → **정규화 후: (0.894, 0, 0.447) (약 63도 기울기)**

> 노멀 벡터의 X, Y 성분을 과장하여 벡터가 표면 법선(기본 Z축 방향)에서 훨씬 더 많이 벗어나도록 만든다

---

## Temporal Offset Mask (시간차 마스크)
시간의 흐름에 따라 반복되는 애니메이션 만들기

- 픽셀 값을 통해 각 픽셀이 언제 빗방울이 생기고 사라질 지 결정한다

```
1. B 채널 값 - Time * Speed
2. Frac (소수점만 남김, 0~1 반복) // 0,1,2,3...9 반복
3. 결과값을 빗방울 애니메이션에 사용
```

---

## frac

Frac(x)의 정의

---

$$
x - floor(x)
$$

---

- `floor(3.14)` = 3
- `floor(-2.7)` = -3 (주의: -2가 아님)

### frac 예시
1. x가 양수일 때 (x > 0)

```
frac(3.14)

floor(3.14) = 3

3.14 - 3 = 0.14
```

2. x가 음수일 때 (x < 0)

```
frac(-2.7)

floor(-2.7) = -3

-2.7 - (-3) = -2.7 + 3 = 0.3
```

> frac(x) 함수의 결과는 항상 0.0 이상 1.0 미만
> - x가 음수여도 y값(결과)은 항상 0과 1 사이를 반복

---

## B - Time 예시
B - Time은 시간이 지날수록 계속 작아지는 음수 값으로 내려감

> 하지만 Frac(소수 부분만 남김) 때문에 **결과는 0~1 구간에서 반복 루프**

### frac(Time) 이해하기
- Time은 0에서부터 계속 증가하는 값 (0, 0.1, 0.2, ... 0.9, 1.0, 1.1, ...)

| Time | (B + t) % 1 | (B - t) % 1 |
| --- | ---| --- |
| 0.0  | 0.0 | 0.0 |
| 0.2  | 0.2 | 0.8 |
| 0.4  | 0.4 | 0.6 |
| 0.6  | 0.6 | 0.4 |
| 0.8  | 0.8 | 0.2 |
| 1.0  | 0.0 | 0.0 |

- **B + t** → 값이 증가하며 0→1로 루프 진행 (정방향)
- **B - t** → 값이 감소하며 1→0으로 루프 진행 (역방향)

> B 값 크기 = 루프 상에서 위상(시작 위치)
> - 따라서 값이 클 수록 늦게 맺히며
> - 시간에 따라 빗방울이 마르거나 스며드는 느낌이 든다

---

## Static/Animated Mask (정적/동적 구분 마스크)
어떤 빗방울을 움직이게 하고(동적), 어떤 빗방울을 멈춰있게 할지(정적) 결정하는 스위치 마스크

- 목표 : Alpha 채널에서 **검은색 점(정적 빗방울)**만 추출하여 **흰색(값 1)**으로 만들고, 나머지 회색/흰색 영역은 모두 **검은색(값 0)**으로 만드는 것

```
1. A 채널 값 * 2 - 0.5
2. 1 번 결과에 * -1
3. saturate로 [0 ~ 1] 범위로 만들기
```

### *2 -1과 *2 -0.5의 차이
**원래 강의 방식**

```
(Alpha * 2  - 1) * -1  →  Power(10) → Saturate
```

| Alpha | *2   | -1    | 결과    |
| ----- | ---- | ----- | ----- |
| 0.00  | 0.00 | -1.00 | -1.00 |
| 0.25  | 0.50 | -0.50 | -0.50 |
| 0.50  | 1.00 | 0.00  | 0.00  |
| 0.75  | 1.50 | 0.50  | 0.50  |
| 1.00  | 2.00 | 1.00  | 1.00  |

- 회색 구간: 0.5 ~ 1.0
- 시작점이 0.5라서 알파 절반(0 ~ 0.5)이 전부 잘려나감
- 회색이 오른쪽(상단 밝은 영역)에 몰림 → 회색 영역이 넓게 느껴짐


| Alpha | *2 -1 | * -1  | Saturate 후 |
| ----- | ----- | ----- | ---------- |
| 0.00  | -1.00 | 1.00  | 1.00       |
| 0.25  | -0.50 | 0.50  | 0.50       |
| 0.50  | 0.00  | 0.00  | 0.00       |
| 0.75  | 0.50  | -0.50 | 0.00       |
| 1.00  | 1.00  | -1.00 | 0.00       |

- 0 ~ 0.5 알파는 1 ~  0 사이 회색 분포
- 회색 구간 넓음 → Power 필요

---

**개선 방식**

```
(Alpha * 2 - 0.5) * -1 → Saturate
```
 
| Alpha | *2   | -0.5  | 결과    |
| ----- | ---- | ----- | ----- |
| 0.00  | 0.00 | -0.50 | -0.50 |
| 0.25  | 0.50 | 0.00  | 0.00  |
| 0.50  | 1.00 | 0.50  | 0.50  |
| 0.75  | 1.50 | 1.00  | 1.00  |
| 1.00  | 2.00 | 1.50  | 1.50  |


- 회색 구간: 0.25 ~ 0.75 → 분포가 알파의 중간에 위치
- → 회색 픽셀이 균등하게 중간에 분포

| Alpha | *2 -0.5 | * -1  | Saturate 후 |
| ----- | ------- | ----- | ---------- |
| 0.00  | -0.50   | 0.50  | 0.50       |
| 0.25  | 0.00    | 0.00  | 0.00       |
| 0.50  | 0.50    | -0.50 | 0.00       |
| 0.75  | 1.00    | -1.00 | 0.00       |
| 1.00  | 1.50    | -1.50 | 0.00       |

- 0.25 이하 알파만 회색값 유지. 나머지 모두 0
- 회색 구간이 매우 좁아서 Power 없이도 깔끔

---

### 정리
1. **원본 방식 (*2 -1)**
    - 0.5를 중심으로 완전히 대칭이라 0과 1 사이에 회색 영역이 넓게 남는다
    - Power로 날카롭게 자를 필요 생김
    - 고비용 함수 사용
2. **수정 방식(*2 - 0.5)**
    - 중심점을 아래로 내려 회색 영역을 미리 압축
    - Saturate만으로도 0 또는 1로 가까워짐
    - Power 함수로 경계를 강제할 필요가 줄어듦
  
---

## Rain Drop Blend Mask
두 마스크 합쳐서 최종 빗방울 효과 완성하기

1. Alpha 채널의 static mask * B 채널의 Offset Mask
    - static mask로 위치를 필터링해서 빗방울이 특정 위치에서만 나타나게 함
    - static mask 1 = 애니메이션 있음
    - static mask 0.5 = 애니메이션 강도 반감
    - static mask 0 = 애니메이션 없음
2. static mask 반전해서 빗방울 고정하기
    - static mask에 -1 곱하여 색상 반전
    - saturate 후 1번과 add
    - 0 + 0.5 = 0.5 고정

> 빗방울이 어떤 곳에서는 움직이고, 어떤 곳에서는 고정된 자국만 남는 시각적 효과 만들어짐

---

## Up Mask (빗방울 방향성 마스크)
위쪽만 젖게 버텍스 노멀을 가져와 블렌드

```
1. VertexNormalWS
2. ComponentMask(Z)
3. Saturate → Up 벡터만 뽑아서 0 ~ 1 단위 
4. 3번 벡터에 비 강도 스칼라(0–1) 값과 곱함

DirectionalMask = UpMask * RainIntensity
```

---

## Roughness mask (젖은 러프니스 마스크)
물방울이 닿은 곳은 더 매끈하게 보이도록 마스크 생성

```
1. blend mask * Directional Mask
2. (선택 사항) 1번의 결과 값을 power에 연결 * 0.1
    - 마스크 대비 조절
    - 모든 픽셀을 1 쪽으로 띄워 부드럽게 만든다
3. 1-x로 반전
    - 러프니스 0 = 반짝임
    - 매끈매끈 해보임
```

---

# 정리

| 처리 단계  | 기능 | 결과 |
| --- | ---| --- |
| Temporal Offset   | 시간 위상 부여    | 빗방울 생성 타이밍 다양화 |
| Static Mask       | 위치 필터       | 어디서 생길지 제어     |
| Offset * Static   | 동적만 활성      | 움직이는 빗방울       |
| + Reversed Static | 정적 병합       | 고정 자국 포함       |
| Up Mask           | 방향성 부여      | 위쪽만 젖음         |
| Power + OneMinus  | 형태 강조 + 반전  | 러프니스 제어 마스크    |
