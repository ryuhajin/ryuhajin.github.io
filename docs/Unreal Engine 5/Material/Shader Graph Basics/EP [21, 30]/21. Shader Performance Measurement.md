---
layout: default
title: "21. Shader Performance Measurement"
parent: "EP [21, 30]"
nav_order: 1
---

# EP 21 : Shader Performance Measurement
Instruction Count만으로 쉐이더 성능을 판단할 수 없다

- 언리얼의 머티리얼 에디터 하단 Stats 패널에는 `Base Pass Shader X instructions`가 표시됨
- 그러나 이 수치는 실제 GPU 성능과 반드시 일치하지 않음

---

# Instruction 이 만들어지는 과정
![](/images/ShaderTranslationSteps.png)

1. **머티리얼 그래프 작성**
   - 엔진이 노드들을 결합해 하나의 HLSL 함수로 만든다

2. **노드가 내부적으로 HLSL/GLSL 코드로 변환**
   - 머티리얼 그래프 상단의 Tools  → Shader Code  → HLSL code 에서 볼 수 있음
   - 이 시점엔 단순 소스 코드만 존재하며 명령어 수는 아직 없음

3. **쉐이더 코드를 그래픽스 API로 전달 (DirectX, Vulkan, OpenGL 등)**
   - 고급 언어 (HLSL) → 중간 어셈블리(Shader Assembly)로 컴파일
   - **컴파일러가 ALU(산술), TEX(텍스처), CF(제어 흐름) 등으로 추정 집계를 제공**
   - 언리얼의 `Base Pass Shader N instructions`는 이 단계의 집계값에 기반

4. **GPU 드라이버가 하드웨어 ISA(명령어)로 변환**
   - GPU별로 다른 실제 명령어와 실행 사이클이 결정
   - **ISA 개수와 실행 사이클이 이 단계에서 최종 결정**
   - 엔진은 이 값을 직접 표시하지 않음 (별도 분석 툴 필요)
   - 이후 GPU에서 병렬 실행

> Graph → HLSL → IR(컴파일러를 거쳐 중간 표현 형태로 바뀜) → ISA(GPU에서 최적화 후 생성되는 실제 명령어) → GPU 실행

---

## Instruction Count가 부정확한 이유
언리얼에서 보여주는 **명령어 수는 실질적인 GPU 사이클 수를 보여주는 것이 아니다**

> 중간 단계의 쉐이더 어셈블리 컴파일러가 대략적인 추정치를 보여주는 것이다

### 1. 루프 오버 카운트
Instruction Count는 **루프가 최대 반복 횟수만큼 실행된다고 가정**

- 실제 실행 횟수가 작더라도 Instruction Count에는 반영되지 않음

```
for (i=0; i<10; i++) { ... }  // 실제는 2회만 돌아도 10회 기준으로 카운트
```

### 2. 데이터 타입에 따른 실행 비용 차이
float 와 float4 모두 **Instruction Count에서 1 instruction으로 카운트**

- 하지만 실제 GPU 실행은 float4일 경우 4 채널을 각각 계산

| 연산 | Instruction Count | 실제 실행 사이클 (예: AMD) |
|---|---|---|
| sin(float)  | 1 | 16 cycles   |
| sin(float4) | 1 | 64 cycles (16×4) |

---

### 3. 연산 종류마다 비용이 다름
모든 instruction이 동일한 코스트를 가지지 않음

- 고비용 함수(sin/cos, pow, atan 등)는 모두 명령어 1개로 카운트 되지만 실제 코스트는 크다

| 함수    | Instruction Count | 실행 사이클(예: Radeon) |
| ----- | --- | --- |
| abs   | 1                 | 0 (free)  |
| mul   | 1                 | 4     |
| sin   | 1                 | 16    |
| tanh  | 6~8 (조합됨)       | 64   |
| atan2 | 1                 | 64+  |


---

## 결론

1. 단순 Instruction Count만 보고 성능을 추측하지 말자
2. GPU마다 같은 instruction이라도 사이클 비용은 다를 수 있다 (ex. 모바일 vs PC)
3. pow, atan2, tanh, sin/cos 등의 함수는 비싼 함수임을 인지하자
4. float 연산은 채널 수만큼 비용이 증가한다
5. 실제 성능 측정은 GPU 프로파일러(예: Unreal Insight / RenderDoc)로 확인하자

**ISA 사이클 수 확인 링크**
- [Shader Playground](https://shader-playground.timjones.io/)
- [Instruction Cycles Sheet](https://docs.google.com/spreadsheets/d/1gIlwVwO9DoQKb-7rpXhvzXcxdZSwPHs_hYHnouQtTYA/edit?gid=0#gid=0)