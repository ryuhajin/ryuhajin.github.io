---
layout: default
title: "34. Interior Mapping"
parent: "EP [31, 40]"
nav_order: 4
---

# EP 34 : Interior Mapping
단순한 cube에 큐브맵을 샘플링하고 UV와 카메라 벡터를 조합해 시점에 따라 내부가 있는 것처럼 보이게 만들기

**알고 넘어가기**
1. 언리얼은 왼손 좌표계, Forward = +X.
    - Tangent space로 변환해도 Forward 축은 그대로 +X 기준
2. 큐브맵은 오른손 좌표계, Forward = +Z.
3. 두 축이 맞지 않아 Tangent space의 X축이 큐브맵 기준에서 거울처럼 뒤집힘

> 이를 보정하기 위해 X축에 -1을 곱해 Tangent space의 Forward 방향을 큐브맵 좌표계 기준으로 맞춤

---

# 그래프 예제

## 텍스쳐 좌표계를 오른손 좌표계로 맞추기
큐브맵은 오른손 좌표계라 텍스쳐 좌표계를 맞춰줘야 함

```
언리얼의 UV 좌표계 (왼손):
- (0,0): Top-Left
- (1,1): Bottom-Right

큐브맵 좌표계 (오른손):
- (0,0): Bottom-Left  
- (1,1): Top-Right
```

1. texCoord 노드 frac 으로 소수부만 가져오기
2. frac * `+2, -2` - `1, -1`
3. 2번에서 만든 값과 scalar `-1` append (왼손 -> 오른손 좌표계 변환)

---

## 카메라 좌표계를 오른손 좌표계로 맞추기

1. 카메라 벡터 노드 불러오기 (카메라 벡터는 중앙에 위치)
2. TransformVector 노드를 사용해 world Space -> tangent space로 변환
3. camera vector * `-1,1,1` (왼손 -> 오른손 좌표계 변환)

---

## Ray–Box Intersection
interior mapping은 ray-box Intersection을 단순화 시켜서 사용함

- ray-box intersection : 실제 교차점 계산

```
Ray:  P(t) = Origin + t * Dir
t:    레이가 진행한 거리

구해야 하는 것:  Ray가 박스의 경계면에 처음 닿는 t_min

tx_min = (box_min.x - origin.x) / dir.x
tx_max = (box_max.x - origin.x) / dir.x
ty_min ...
tz_min ...
t_min = max( min(tx_min, tx_max), min(ty_min, ty_max), min(tz_min, tz_max) )
```

- interior mapping : 실제 교차점 계산 X

```
// "가장 가까운 면만" 찾기
t_x = (1 - P.x) / V.x  // 오른쪽 벽까지
t_y = (1 - P.y) / V.y  // 위쪽 벽까지
t_z = (1 - P.z) / V.z  // 앞쪽 벽까지

// 가장 작은 t값 = 가장 먼저 닿는 벽
t_min = min(t_x, t_y, t_z)
```

**링크**
- [총알 충돌(벡터 / AABB (Axis-Aligned Bounding Box) 교차)](https://youtu.be/USjbg5QXk3g?si=2j2tcuWKBJ-zjQbW)
- [Ray-box intersection algorithm](https://developer.arm.com/documentation/102179/0100/Implement-reflections-with-a-local-cubemap/Ray-box-intersection-algorithm)

---

## 패럴랙스 계산
- 목표: 픽셀 위치(UV)에서 카메라 시선 방향으로 가상의 큐브 내부로 레이를 쏘고, 가장 먼저 맞는 벽의 교차점을 계산
- 도구: UV 좌표 (로컬 위치), 카메라 벡터 (탄젠트 공간)
- 결과: 큐브맵의 어느 방향을 샘플할지 결정하는 3D 좌표

1. 카메라 벡터의 **역수(Reciprocal) 구하기** :  `1 / Camera Vector`
    - 광선이 각 축으로 1 만큼 진행할 때의 상대적 이동 거리 (스케일 팩터)를 계산
    - 예: 카메라가 오른쪽을 보고 있으면 y축 방향으로 얼마 가야 y=1 면에 닿는지
2. 1번에서 구한 **factor를 UV coord와 곱한다** : `factor * UV coord`
   - **광선의 시작점이 UV**
   - 해당 시작점에서 **카메라 방향으로 광선이 진행될 때, 축별로 얼마나 이동하는지 스케일링**
3. **abs로 절대값 구하기** : `Abs(1 / Camera Vector)`
    - 교차 거리는 음수가 되면 의미가 없으므로 절댓값을 취한다
4. 각 축별로, **픽셀에서 광선을 쐈을 때 큐브의 경계에 닿기까지 남은 거리** : `Abs - (factor * UV coord)`
    - D.x, D.y, D.z 중 가장 작은 값 = 가장 먼저 맞닿는 벽
5. 광선이 어떤 면과 교차하는지 결정하기 : `t = min(D.x, D.y, D.z)`
6. 교차 지점까지 변위 계산 : `P = t * camera vector`
    - 결정된 t 값을 사용해 광선이 그 지점까지 얼마나 이동하는지 계산
    - 이 값은 **큐브 내부의 충돌 위치 좌표**
7. 원래 표면 좌표에 교차점까지의 변위 더해 최종 좌표 구하기 : `UV coord + P`
