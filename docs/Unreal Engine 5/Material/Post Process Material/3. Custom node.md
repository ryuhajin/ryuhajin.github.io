---
layout: default
title: "3. Custom node"
parent: "Post Process Material"
nav_order: 3
---

# 3. Custom node
HLSL 코드 사용 가능한 노드. code 창에 HLSL 코드 사용 가능

---

## input
입력 배열로 추가하면 핀 생성 됨. 해당 핀에 연결해서 사용함

1. **inputs** : 표현식에 사용되는 입력 배열
2. **Additional Defines** : HLSL 코드에서 필요한 추가 정의(Defines)를 추가
    -  배열에 요소를 추가할 때는 정의 이름과 정의 값 프로퍼티를 지정
3. **Include File Paths** : 셰이더 경로 외부의 소스 파일에서 포함시키고자 하는 셰이더 코드의 파일 경로를 지정

---

## output
아웃풋도 핀으로 연결

1. **Output Type** : 표현식의 출력 값 유형 (종류 선택)
2. **Additional Outputs** : 추가적인 출력 핀을 정의
    - 해당 요소의 출력 이름 과 출력 유형 프로퍼티룰 지정

---

# Custom 머티리얼 표현식을 작성할 때 주의점!
Custom 머티리얼 표현식을 작성할 때 주의해야 할 사항

1. ❓**정말 Custom 노드가 필요한가?**❓
    - 먼저 언리얼의 기본 제공 노드들만으로 원하는 효과를 구현할 수 있는지 검토하기
   - **기본 노드로 구현된다면 그것이 항상 더 나은 선택**
2. **단순화 및 모듈화**
    - 기능별로 여러 개의 작은 Custom 노드로 분할하면 디버깅과 재사용이 용이

---

## HLSL code 작성
엔진에서는 사용자가 작성한 Custom 노드 코드를 그대로 사용하지 않고, **하나의 큰 함수 안에 감싸서 컴파일한다**

```c++
// [엔진이 자동으로 생성하는 코드]
float3 CustomExpression0(float3 InWorldPos, float2 UV, Texture2D Tex, SamplerState TexSampler)
{
    // ▼▼▼ 여기에 사용자의 Custom 노드 코드가 들어감 ▼▼▼
    struct InnerStruct {
        float4 Run() {
             // ❌ 래퍼 함수 인자(Tex, TexSampler, UV)에 직접 접근 불가
            return Texture2DSample(Tex, TexSampler, UV); // 에러!
        }
    };
    InnerStruct S;
    return S.Run();
    // ▲▲▲ 사용자의 코드 끝 ▲▲▲
}
```

**문제점**
1. 노드 입력들(Tex, TexSampler, UV 등)은 그 바깥 래퍼 함수의 **매개변수(= 함수 지역 변수)**
2. 구조체 멤버 함수 : **바깥 함수의 지역 변수에 접근할 수 없음**

---

## 해결 방법

### 구조체 필드에 복사 후 맴버 함수 사용

```c++
struct InnerStruct {
    Texture2D    Tex;
    SamplerState Samp;
    float2       UV;

    float4 Run() { return Texture2DSample(Tex, Samp, UV); }
};

InnerStruct S;
S.Tex  = Tex;          // 함수 인자 → 구조체 필드로 복사
S.Samp = TexSampler;
S.UV   = UV;
return S.Run().rgb;
```

---

### 멤버 함수에 파라미터 전달

```c++
struct InnerStruct {
    float4 Run(Texture2D LocalTex, SamplerState LocalSamp, MaterialFloat2 LocalUV) {
        // ✅ 파라미터로 전달받아서 사용
        return Texture2DSample(LocalTex, LocalSamp, LocalUV);
    }
};

InnerStruct S;
// 실행 시 필요한 파라미터 전달
return S.Run(Tex, TexSampler, UV).rgb;
```

> 참고: 정밀도 호환성을 위해 float 대신 `MaterialFloat*` 매크로 사용 권장
> 
---

### 더 깊게 공부하기
- Unreal Engine Shader Development (HLSL): `.usf` 또는 `.ush` 확장자를 가진 언리얼 쉐이더 파일들을 직접 탐색
    - `Engine/Shaders/` 디렉토리 살펴보기

---

**링크**
- [UE5 - Custom 머티리얼 표현식](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/custom-material-expressions-in-unreal-engine?application_version=5.5)