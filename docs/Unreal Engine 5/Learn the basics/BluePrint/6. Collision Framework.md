---
layout: default
title: "6. Collision Framework"
parent: "BluePrint"
nav_order: 6
---

# 6. Collision Framework
콜리전 시스템 이해하기

## Primitive component
콜리전은 **프리미티브 컴포넌트에서 시작된다**

- 아래의 컴포넌트들은 모두 **Primitive Component 클래스에서 파생**되었기 때문에 충돌 데이터를 가질 수 있음

```
Primitive components

- static mash components
- sphere components
- capsule components
- etc...
```
<br>
![](/images/UE5_collision_primitive.png)

> "액터(Actor)가 충돌한다"라고 말할 때, 정확히는 "액터를 구성하는 특정 프리미티브 컴포넌트가 충돌한다"는 의미
> - 충돌은 실제로는 Actor 간이 아니라 Component 간의 상호작용
> - 하나의 액터는 여러 개의 충돌 컴포넌트를 가질 수 있다

---

## Collision vs Query
충돌 시스템은 크게 두 가지 목적을 위해 사용

<br>

![](/images/UE5_collision_queries.png)

1. **Physics collision** :실제 물리적 접촉이나 교차 (intersection)
   - 실제 물리 법칙에 따라 객체가 부딪히고 튕겨나가는 등의 시뮬레이션을 위한 충돌
   - 객체에 중력, 힘을 가했을 때 다른 객체와의 접촉을 계산
2. **Spatial query** : “충돌이 일어날까?”를 계산하는 가상 검사
   - **LineTrace** : 지정한 방향으로 광선을 발사해 어느 물체에 부딪히는지 확인
   - **Shape Sweep** : LineTrace와 유사. 선이 아닌 특정 도형을 가지고 확인
   - **overlap** : 특정 영역 안에 다른 객체가 들어왔는지 여부를 감지

---

## Collision data

<br>

![](/images/UE5_collision_data.png)

1. **Collision Geometry**
    - 단순형(Simple): Box, Capsule, Sphere, Convex Hull → 빠름
    - 복잡형(Complex): 실제 메시 삼각형 기반 → 느림
2. **Collision Settings**
    - 엔진이 해당 Geometry를 어떻게 계산할지 정의
    - 쿼리 시스템, 피직스 시스템 두 계산 시스템 존재

---

## Collision Settings
**콜리전 세팅에 따라 콜리전 지오메트리를 처리하는 방식이 결정**된다

```
Query System (Overlaps, Traces 등)

Physics System (물리 시뮬레이션, 힘, 중력 등)
```

### Collision Enabled 설정
컴포넌트가 어떤 계산에 참여할지 결정

| 설정                            | 설명                           |
| ----------------------------- | ---------------------------- |
| **No Collision**              | 충돌 없음                        |
| **Query Only**                | 쿼리 시스템만 사용, 피직스 콜리전 없음 |
| **Physics Only**              | 피직스 시스템만 사용, 피직스(물리)의 결과로 콜리전을 감지 |
| **Query and Physics**         | 쿼리 시스템과 피직스 시스템 둘 다 사용 (비용 ↑) |
| **Probe Only (Contact Data)** | 콜리전의 결과로 힘(forces)을 가하지 않음<br> 피직스(물리)의 결과로 콜리전 데이터를 감지 (히트 콜백 실행)<br> 쿼리 시스템을 사용하지 않음 |
| **Query and Probe**           | Query + probe olny |

---

## Collision Object Type
충돌할 때 해당 오브젝트가 어떤 분류에 속하는지 정의 (예: 벽, 플레이어, 적의 총알)

### Collision Channel
콜리전 관점에서 이 컴포넌트의 타입을 식별. 채널에는 두 가지가 있다

1. **트레이스 채널 (Trace Channels)**
   - 라인 트레이스 등 쿼리용
   - 오브젝트(컴포넌트)에 할당될 수 없음
2. **오브젝트 채널 (Object Channels)**
   - 오브젝트 타입 지정용
   - 오브젝트(컴포넌트)에 할당

> WorldStatic, WorldDynamic, Pawn, PhysicsBody 등 미리 정의된 채널이 있음
> - 커스텀 채널도 생성 가능

---

## Collision Responses
**콜리전이 있는 모든 오브젝트는 콜리전 반응이 있음**

- 콜리전 리스폰스는 **다른 객체 콜리전 채널에 대해 이 객체가 어떻게 반응할지 결정**

1. **무시 (Ignore)**
    - 콜리전 상호작용 없음
    - 콜백(callbacks) 없음
2. **오버랩 (Overlap)**
    - 오브젝트가 **서로 통과함**
    - 오버랩 콜백을 트리거(발생)시킬 수 있음
3. **블록 (Block)**
    - 오브젝트가 **막힘**
      - 피직스(물리) 시뮬레이션 중일 경우
      - 스윕(sweeping) 중일 경우
    - hit 콜백 트리거 발생

---

## Collision Presets
위에서 본 **세 가지 설정(Collision setting, Object Type, Responses)을 조합해 하나의 프로필로 저장해둔 것**

### Collision Profile
콜리전 활성화, 콜리전 오브젝트 타입, 콜리전 응답

![](/images/UE5_collision_presets.png)

1. 콜리전이 있는 컴포넌트는 콜리전 프리셋 (Collision Presets) 속성을 가짐
2. 프리셋을 선택하면, 전체 콜리전 프로파일이 채워짐
3. 언리얼 엔진에는 여러 내장 프리셋이 있음
4. 커스텀 프리셋을 만들 수 있음
    - 개수 제한이 없음
    - 커스텀 콜리전 채널을 만드는 것보다 권장

> 프로파일을 설정하여 많은 수의 오브젝트에 쉽게 적용할 수 있다

---

## Collision Filtering
두 객체 **A와 B가 만날 때, 최종 충돌 결과를 결정 짓는 규칙**

- 두 오브젝트의 **Object Type과 Response를 비교하여 결과 결정**

### 📌 중요 규칙!

```
Ignore: 충돌 무시
Overlap: 겹침 이벤트 발생 (통과 가능)
Block: 막힘 (물리적 충돌 발생)
```

> A,B 충돌 시 가장 약한 결과 선택
> - Ignore < Overlap < Block
> - 즉, 둘 다 Block 해야 실제 충돌시 막힘 (Block) 발생

![](/images/UE5_collision_filtering.png)

### 예시
오브젝트 A (Pawn) 와 오브젝트 B (World Static) 가 만났을 때

1. B의 콜리전 오브젝트 타입(WorldStatic)에 대한 **A의 응답**
    - **A는 B를 블록(Block)** (A의 설정: `WorldStatic: Block`)
2. A의 콜리전 오브젝트 타입(Pawn)에 대한 **B의 응답**
    - **B는 A를 오버랩(Overlap)** (B의 설정: `Pawn: Overlap`)
3. 결과적인 콜리전 상호작용은 **오버랩(Overlap)**
    - 규칙: Block과 Overlap 중 덜 막는 Overlap 선택

---

## Collision Callbacks
충돌이 감지되면, 그 **결과를 게임 로직에서 처리할 수 있도록 이벤트가 발생**

> 등록된 콜리전 상호작용에 대한 응답으로 실행

![](/images/UE5_collision_callbacks.png)

1. **오버랩 콜백 (Overlap Callbacks)**
    - **On Component Begin Overlap, Actor Begin Overlap**
      - **오버랩(Overlap) 상호작용에 대한 응답**
      - 두 오브젝트 모두 **Generate Overlap Events (오버랩 이벤트 생성)**가 **true (참)**로 설정되어 있어야 함
2. **히트 콜백 (Hit Callbacks)**
    - **On Component Hit**
      - **블로킹(Blocking) 상호작용 또는 프로브(Probe)에 대한 응답**
      - 피직스 콜리전인 경우:
        - 히트 이벤트를 생성하는 컴포넌트는 **Simulation Generates Hit Events (시뮬레이션이 히트 이벤트 생성)**가 **true (참)**로 설정되어 있어야 함
      - 피직스 콜리전이 아닌 경우: **스위핑(sweeping) 이동**의 결과여야 함

---

## Sweep
스윕은 이동 경로를 따라 충돌 검사를 수행하는 기능이다

> 객체를 A지점에서 B지점으로 이동시킬 때 A와 B를 잇는 선을 따라 장애물이 있는지 미리 검사하는 것!
> - 즉, 스윕은 "이동 중에도 충돌을 유지하겠다" 는 선언

### Sweep on/off

| | 스윕 ON (Sweep = True)	| 스윕 OFF (Sweep = False) | 
|---|---|
방식	| 이동 경로를 쓸어가며(Sweep) 검사	| 최종 위치로 순간이동(Teleport)| 
충돌 반응	| 이동 중 Blocking 객체를 만나면 이동 중단	|  아무리 장애물이 있어도 무시하고 최종 위치로 감 | 
결과 | 객체가 겹치지 않음 | 객체가 서로 겹쳐질 수 있음 | 

---

### 코드 예시

```c++
// 1) 스윕을 켜고 이동 (장애물을 피해감)
SetActorLocation(NewLocation, true); // Sweep = true

// 2) 스윕을 끄고 이동 (장애물을 뚫고 감)
SetActorLocation(NewLocation, false); // Sweep = false


FHitResult Hit;
AddActorWorldOffset(FVector(100, 0, 0), true, &Hit); // 스윕을 켜고 이동 // Sweep = true

if (Hit.IsValidBlockingHit())
{
    UE_LOG(LogTemp, Warning, TEXT("Hit something: %s"), *Hit.Actor->GetName());
}
```

1. 스윕 활성화 시 시작점 → 도착점 사이를 가상의 볼륨(primitive collision shape)으로 스캔
2. 경로 중간에 Block 충돌이 감지되면 이동이 멈춤
3. 충돌한 컴포넌트에 대해 Hit 결과(FHitResult) 를 반환
4. 충돌 콜백(OnHit)이 실행될 수도 있음

---

### Sweep 특징
1. **쿼리 시스템 사용**
    - 스윕은 쿼리 시스템(Query) 을 사용
    - 따라서 Collision Enabled가 **Query Only 또는 Query and Physics인 객체만 스윕 이동을 막을 수 있음**
2. **성능 비용**
    - **스윕은 매 프레임 이동 경로를 계산해야 하므로, 순간이동보다 더 많은 연산이 필요**
    - 불필요한 경우 스윕을 끄면 성능을 약간 향상시킬 수 있음
3. **이벤트 발생**
    - 스윕 중 Blocking 객체를 만나면 Hit 이벤트가 발생
    - **Overlap 설정이 되어 있더라도, Sweep은 막힘(block)이 아닌 단순 겹침은 통과**
    - 이는 OnComponentHit 같은 이벤트를 트리거

---

## Method of movement
컴포넌트가 움직이는 방식은 중요하다

```
같은 충돌 설정이라도 객체를 어떻게 움직이느냐에 따라 충돌 결과가 달라질 수 있다
```

![](/images/UE5_methodOfMovement.png)

1. **직접 이동 (Moved Directly)**
    - **Set Actor Location (액터 위치 설정), Add Actor World Offset (액터 월드 오프셋 추가)**
    - **스위핑(Sweeping) 또는 스위핑 없음**
        - **스위핑 없음** : 충돌 계산 없음. 두 오브젝트를 같은 위치에 놓을 수 있음
        - **스위핑** : 이동 중 막히는 오브젝트 감지 (쿼리 시스템 사용)
2. **피직스(물리)를 통한 이동 (Moved via Physics)**
    - Add Force (힘 추가)
3. **이동 컴포넌트 (Movement Component)**
    - **프로젝타일 무브먼트 컴포넌트 (Projectile Movement Component)**
      - 피직스(물리)가 활성화되었는지 확인
      - 피직스(물리)가 없다면, 스위핑이 활성화됨
        - 스위핑은 비활성화될 수 있음
    - **캐릭터 무브먼트 컴포넌트 (Character Movement Component)**
        - 캐릭터 이동은 내부적으로 항상 Sweep을 사용 (쿼리 시스템을 사용하여 이동)
        - 피직스(물리)를 시뮬레이션함
        - 피직스 오브젝트에 힘을 가함
