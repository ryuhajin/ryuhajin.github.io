---
layout: default
title: "2. Applying to Unreal Engine"
parent: "ToonShader"
nav_order: 2
---

# 2. Applying to Unreal Engine
HLSL로 구현한 툰 쉐이더를 언리얼 엔진에 적용해보자

---

# Custom node
사용해봤으나 HLSL의 Forward redering 방식과 안맞아서 제대로 셀 셰이딩이 그려지지 않음.

노말 각도, 빛 방향 계산하는데서 문제가 있는듯

**참고 링크**
- [custom-material](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/custom-material-expressions-in-unreal-engine)
- [Using Custom HLSL Code - Advanced Materials](https://youtu.be/qaNPY4alhQs?feature=shared)

---

## G-buffer
지연 렌더링 (Deferred Rendering) 방식의 Geometry Pass 과정에서 오브젝트를 한번 씩 그리며 
렌더링에 필요한 '재료' 정보들을 여러 장의 텍스처에 저장

> 텍스처들의 묶음이 바로 G-Buffer이다

### 텍스처 형태로 저장되는 G-Buffer 안의 정보
- **Base Color**: 물체의 기본 색상
- **World Normal**: 표면의 법선 벡터 (조명 계산에 필수)
- **Roughness**: 표면의 거칠기
- **Metallic**: 금속성
- **Specular**: 반사광의 색상 및 강도
- **Scene Depth**: 카메라로부터의 깊이(거리) 정보
- **Custom Data**: 그 외 렌더링에 필요한 다양한 데이터

> - 포스트 프로세스는 바로 이 G-Buffer의 데이터를 입력으로 받아
> - 화면 전체에 특수 효과(SSAO, 블룸, 모션 블러 등)를 적용하는 과정

---

## G-Buffer 직접 확인하기
1. UE5 에디터의 메인 뷰포트 좌측 상단에 있는 [Lit] 버튼을 클릭
2. 드롭다운 메뉴에서 [Buffer Visualization] 항목으로 마우스를 가져감
3. 다양한 G-Buffer 목록이 나타남. 여기서 보고 싶은 버퍼를 선택

### 주요 시각화 모드
- **Base Color**
  - 물체의 기본 색상 정보만 보여줌. 조명 효과가 모두 제거된 **순수한 텍스처 색상**을 볼 수 있음
- **World Normal**
  - 픽셀의 **법선 벡터를 색상으로 표현**. 주로 조명 계산 디버깅이나 외곽선 검출 같은 효과를 만들 때 이 정보를 사용
- **Roughness**
  - 표면의 거칠기를 흑백으로 보여줌.
  - **검은색(0)에 가까울수록 매끈하고, 흰색(1)에 가까울수록 거칠다**
- **Metallic**
  - 금속성을 흑백으로 보여줌.
  - **흰색(1)은 순수 금속, 검은색(0)은 비금속.**
- **Scene Depth**
  - **카메라로부터의 거리**를 흑백으로 표현. **가까울수록 어둡고 멀수록 밝게 나타남**.
  - 안개(Fog)나 심도 효과(Depth of Field) 등에 사용.
- **Ambient Occlusion**
  - 물체가 **서로 겹치거나 구석진 곳에 생기는 그림자를 계산한 결과**. (만약 SSAO가 켜져 있다면)

---

### G-buffer 데이터를 사용해 HLSL로 써보는 예시

- UE5의 포스트 프로세스 머티리얼에서는 SceneTexture 노드를 통해 G-Buffer에 접근할 수 있다

```c++
// G-Buffer 텍스처들을 샘플링하기 위한 선언 (실제 UE 코드는 더 복잡하지만 개념은 동일)
Texture2D<float4> GBufferATexture; // BaseColor가 저장된 텍스처
Texture2D<float4> GBufferBTexture; // Roughness, Metallic 등이 저장된 텍스처
Texture2D<float> SceneDepthTexture; // 씬 깊이 텍스처
SamplerState GBufferSampler;

// PostProcess 메인 함수
float4 MainPS(float2 UV : SV_Position) : SV_Target0
{
    // 현재 픽셀의 UV 좌표로 G-Buffer 샘플링
    float4 gBufferB = GBufferBTexture.Sample(GBufferSampler, UV);

    // GBufferB의 특정 채널에서 Roughness 값을 읽어옴 (예: R 채널)
    float roughness = gBufferB.r;

    // 최종 화면 색상을 가져옴 (보통 다른 텍스처에 저장되어 있음)
    float4 finalColor = GetFinalSceneColor(UV); 

    // 조건: Roughness가 0.8 이상인가?
    if (roughness > 0.8)
    {
        // 조건을 만족하면 노란색(1,1,0)과 원래 색상을 섞어줌
        finalColor.rgb = lerp(finalColor.rgb, float3(1.0, 1.0, 0.0), 0.5);
    }

    return finalColor;
}
```

---

## 외부 그래픽스 디버깅 툴
RenderDoc은 특정 프레임의 모든 렌더링 과정을 '캡처'하여, 각 단계(Draw Call)에서 어떤 데이터가 어떻게 처리되는지 분석할 수 있게 해주는 강력한 무료 툴

- [RenderDoc](https://renderdoc.org/)

## 사용 방법

### UE5 에디터와 연동
1. RenderDoc을 실행
2. File -> Launch Application을 선택
3. Executable Path에 UE5 에디터 실행 파일(.../UE_5.x/Engine/Binaries/Win64/UnrealEditor.exe)을 지정.
4. Command-line arguments에 분석하고 싶은 프로젝트 파일(.uproject)의 전체 경로를 입력.
5. [Launch] 버튼을 눌러 RenderDoc을 통해 에디터를 실행합니다.

### 프레임 캡처
1. 에디터가 실행되면 뷰포트에 RenderDoc 오버레이가 표시됨.
2. F12 또는 지정된 캡처 키를 눌러 원하는 순간의 프레임을 캡처.

### G-Buffer 확인
1. 캡처된 파일이 RenderDoc에서 열림.
2. 왼쪽의 Event Browser에서 BasePass 또는 Scene/Render/GBuffers 와 관련된 이벤트를 찾음.
3. 오른쪽의 Texture Viewer 탭을 연다.
4. Output Merger 섹션에 있는 렌더 타겟(Render Targets) 목록을 확인
5. GBufferA, GBufferB, GBufferC 등 이름으로 저장된 텍스처들을 볼 수 있음.
6. 각 텍스처를 클릭하면 해당 버퍼의 내용을 상세하게 (픽셀 단위로) 확인 가능.

> 각 G-Buffer 텍스처의 채널(R, G, B, A)에 어떤 데이터가 어떻게 압축되어 저장되는지 까지 볼 수 있다

---





---

**참고 링크**

- [adding-global-shaders-to-unreal-engine](https://dev.epicgames.com/documentation/en-us/unreal-engine/adding-global-shaders-to-unreal-engine)
- [post-process-effects-in-unreal-engine](https://dev.epicgames.com/documentation/en-us/unreal-engine/post-process-effects-in-unreal-engine)
- [post-process-materials-in-unreal-engine](https://dev.epicgames.com/documentation/en-us/unreal-engine/post-process-materials-in-unreal-engine)
- [overview-of-shaders-in-plugins-unreal-engine](https://dev.epicgames.com/documentation/en-us/unreal-engine/overview-of-shaders-in-plugins-unreal-engine)
- [new-shading-models-and-changing-the-gbuffer](https://dev.epicgames.com/community/learning/tutorials/2R5x/unreal-engine-new-shading-models-and-changing-the-gbuffer)


---

- [color-grading-and-the-filmic-tonemapper](https://dev.epicgames.com/documentation/en-us/unreal-engine/color-grading-and-the-filmic-tonemapper-in-unreal-engine)
- [auto-exposure-eye-adaptation](https://dev.epicgames.com/documentation/en-us/unreal-engine/auto-exposure-eye-adaptation?application_version=4.27)
- [how-to-add-post-process-material](https://dev.epicgames.com/community/learning/tutorials/8kB9/unreal-engine-how-to-add-post-process-material)
- [luts-complete-guide](https://www.worldofleveldesign.com/categories/ue5/luts-complete-guide.php)

---

- [Articles](https://www.froyok.fr/articles.html)
- [Global shaders in Unreal without engine modification](https://itscai.us/blog/post/ue-view-extensions/)
- [UE4ShadersIntroduction](https://logins.github.io/graphics/2021/03/31/UE4ShadersIntroduction.html)